<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Pals - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="Icon.png" type="image/png">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Load Supabase JS and config loader first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config-loader.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --dark-blue: #1a2238;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            line-height: 1.6;
            background-color: #ffffff;
        }
        .navbar {
            background-color: var(--dark-blue);
        }
        .navbar-brand, .nav-link {
            color: white;
        }
        .nav-link:hover {
            color: var(--gold);
        }
        .nav-link.active {
            color: var(--gold) !important;
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .stats-card h3 {
            color: var(--dark-blue);
            margin-bottom: 15px;
        }
        .footer {
            background-color: var(--dark-blue);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-top: 40px;
        }
        .footer a {
            color: var(--gold);
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a2238;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .navbar-toggler-icon {
            background-color: unset;
        }
        
        /* Box League Styles */
        .box-league-container {
            margin-bottom: 40px;
        }
        .league-table {
            width: 100%;
            overflow-x: auto;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .league-table table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .league-table th, .league-table td {
            padding: 8px 12px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .league-table th {
            background-color: rgba(26, 34, 56, 0.7);
            color: white;
            position: sticky;
            top: 0;
        }
        .league-table th:first-child {
            text-align: left;
            min-width: 150px;
        }
        .league-table td:first-child {
            text-align: left;
        }
        .league-table .team-name {
            font-weight: 500;
        }
        .match-result {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
        }
        .match-win {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        .match-loss {
            background-color: rgba(220, 53, 69, 0.15);
            color: #dc3545;
        }
        .match-unplayed {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }
        .match-scheduled {
            background-color: rgba(0, 123, 255, 0.15);
            color: #007bff;
        }
        .match-walkover-win {
            background-color: rgba(0, 123, 255, 0.2);
            color: #007bff;
        }
        .match-walkover-loss {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .matches-container {
            max-height: 360px;
            overflow-y: auto;
        }
        .match-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .match-card .match-date {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .match-card .team-names {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
        }
        .match-card .team {
            max-width: 45%;
            text-align: center;
        }
        .match-card .score {
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        .match-status {
            display: inline-block;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        .status-scheduled {
            background-color: rgba(0, 123, 255, 0.2);
            color: #007bff;
        }
        .status-completed {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        .status-walkover {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .placeholder-text {
            color: #6c757d;
            font-style: italic;
        }
        #boxSelector select {
            background-color: #343a40;
            color: #f8f9fa;
            border: 1px solid #495057;
            padding: 8px 12px;
            border-radius: 5px;
            width: 100%;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #leagueSelector select {
            background-color: #343a40;
            color: #f8f9fa;
            border: 1px solid #495057;
            padding: 8px 12px;
            border-radius: 5px;
            width: 100%;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23f8f9fa' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }
        .form-select:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25);
        }
        .form-label {
            color: #333333;
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
        }
        .status-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .status-filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #495057;
            background-color: #343a40;
            color: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        /* Status-specific styling */
        .status-filter-btn[data-status="active"] {
            background-color: #1e3a8a;
            border-color: #1e4d8a;
            color: #ffffff;
        }
        .status-filter-btn[data-status="upcoming"] {
            background-color: #0e7490;
            border-color: #0e6890;
            color: #ffffff;
        }
        .status-filter-btn[data-status="completed"] {
            background-color: #4b5563;
            border-color: #6b7280;
            color: #ffffff;
        }
        .status-filter-btn[data-status="cancelled"] {
            background-color: #991b1b;
            border-color: #7f1d1d;
            color: #ffffff;
        }
        .status-filter-btn[data-status="all"] {
            background-color: #525252;
            border-color: #6b7280;
            color: #ffffff;
        }
        .status-filter-btn.active {
            background-color: var(--dark-blue);
            border-color: var(--dark-blue);
            color: var(--gold);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }
        .status-filter-btn:hover:not(.active) {
            filter: brightness(1.2);
            transform: translateY(-1px);
        }
        .form-select option {
            background-color: #343a40;
            color: #f8f9fa;
            padding: 8px;
        }
        /* Custom selection area styling */
        .selector-area {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L426ZMNKFK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-L426ZMNKFK');
    </script>
    <!-- End Google Analytics -->
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="images/Icon.png" alt="Padel Pals Logo" style="height: 40px; margin-right: 10px;">
                Padel Pals
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="support.html">Support</a></li>
                    <li class="nav-item"><a class="nav-link" href="privacy.html">Privacy Policy</a></li>
                    <li class="nav-item"><a class="nav-link" href="boxleague.html">Box League</a></li>
                    <li class="nav-item"><a class="nav-link" href="guide.html">App Guide</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="signOut">Sign Out</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2>Loading your data...</h2>
            <p id="loadingMessage" class="info-message" style="display: none;">Preparing your dashboard...</p>
            <div id="loadingDebug" style="margin-top: 20px; text-align: left; display: none;">
                <h4>Debug Information:</h4>
                <pre id="debugInfo" style="background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 300px; overflow: auto;"></pre>
                <button id="goToAuth" class="btn btn-primary mt-3" style="display: none;">Go to Sign In</button>
                <div id="manualAuthForm" style="display: none; margin-top: 20px;">
                    <h4>Manual Authentication</h4>
                    <div class="mb-3">
                        <input type="email" class="form-control" id="emailInput" placeholder="Email">
                    </div>
                    <div class="mb-3">
                        <input type="password" class="form-control" id="passwordInput" placeholder="Password">
                    </div>
                    <button id="manualSignIn" class="btn btn-primary">Sign In</button>
                </div>
            </div>
        </div>
        
        <div id="dashboardContent" style="display: none;">
            <h1 class="mb-4">Welcome, <span id="userName">User</span>!</h1>
            
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="boxleague-tab" data-bs-toggle="tab" data-bs-target="#boxleague" type="button" role="tab" aria-controls="boxleague" aria-selected="true">Box League</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" aria-controls="stats" aria-selected="false">Stats</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Settings</button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="dashboardTabContent">
                <!-- Box League Tab -->
                <div class="tab-pane fade show active" id="boxleague" role="tabpanel" aria-labelledby="boxleague-tab">
                    <div class="box-league-container">
                        <div class="selector-area">
                            <div id="statusFilter" class="mb-4">
                                <!-- Status filter will be populated here -->
                            </div>

                            <div id="leagueSelector" class="mb-4">
                                <!-- League selector will be populated here -->
                            </div>
                            
                            <div id="boxSelector" class="mb-4">
                                <!-- Box selector will be populated here -->
                            </div>
                        </div>
                        
                        <div id="leagueTableContainer" class="mb-4">
                            <!-- League table will be populated here -->
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <h3>Upcoming Matches</h3>
                                    <div id="upcomingMatches" class="matches-container">
                                        <!-- Upcoming matches will be loaded here -->
                                        <p class="placeholder-text">Loading upcoming matches...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stats-card">
                                    <h3>Match Results</h3>
                                    <div id="matchResults" class="matches-container">
                                        <!-- Match results will be loaded here -->
                                        <p class="placeholder-text">Loading match results...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Tab -->
                <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="stats-card">
                                <h3>Match Statistics</h3>
                                <div id="matchStats">
                                    <!-- Match stats will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <h3>Recent Matches</h3>
                                <div id="recentMatches">
                                    <!-- Recent matches will be loaded here -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <h3>Box League Status</h3>
                                <div id="boxLeagueStatus">
                                    <!-- Box league status will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                    <div class="stats-card">
                        <h3>Account Settings</h3>
                        <div id="accountSettings">
                            <!-- Account settings will be loaded here -->
                            <p>Account settings coming soon.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Authentication Test Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="stats-card">
                        <h3>Authentication & Connection Test</h3>
                        <div id="connectionTest">
                            <div class="spinner" style="width: 20px; height: 20px;"></div>
                            <p>Testing connection...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Padel Pals. All rights reserved.</p>
            <p>
                <a href="support.html">Support</a> |
                <a href="privacy.html">Privacy Policy</a> |
                <a href="boxleague.html">Box League Rules</a> |
                <a href="guide.html">App Guide</a>
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let supabase;
        let debugInfoElement;
        let redirectAttempted = false; // Flag to prevent infinite loops
        let authRedirectTime = parseInt(localStorage.getItem('authRedirectTime') || '0');
        const currentTime = Date.now();
        
        // Add debug information
        function addDebugInfo(message) {
            console.log(message);
            if (debugInfoElement) {
                debugInfoElement.textContent += message + '\n';
            }
        }
        
        // Show a loading message
        function showLoadingMessage(message, isError = false) {
            const messageElement = document.getElementById('loadingMessage');
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = isError ? 'error-message' : 'info-message';
                messageElement.style.display = 'block';
            }
        }
        
        // Initialize page elements
        document.addEventListener('DOMContentLoaded', function() {
            debugInfoElement = document.getElementById('debugInfo');
            
            // Check for recent redirect to prevent loops
            if (currentTime - authRedirectTime < 5000) { // 5 seconds
                // We've been redirected too recently, stay on this page
                document.getElementById('loadingDebug').style.display = 'block';
                document.getElementById('goToAuth').style.display = 'block';
                showLoadingMessage('Detected a potential redirect loop. Please click "Go to Sign In" to authenticate manually.', true);
                addDebugInfo('Potential redirect loop detected. Staying on dashboard page.');
            }
            
            // Set up button listeners
            document.getElementById('goToAuth').addEventListener('click', function() {
                window.location.href = '/auth.html';
            });
        });
        
        // Listen for the configLoaded event from config-loader.js
        document.addEventListener('configLoaded', function() {
            addDebugInfo('Configuration loaded successfully');
            addDebugInfo(`Supabase URL: ${window.config.supabaseUrl}`);
            addDebugInfo(`API key available: ${window.config.supabaseKey ? 'Yes' : 'No'}`);
            
            // Initialize Supabase with loaded configuration
            initializeDashboard();
        });
        
        // Main dashboard initialization function
        function initializeDashboard() {
            try {
                // Create Supabase client
                supabase = window.supabase.createClient(
                    window.config.supabaseUrl,
                    window.config.supabaseKey
                );
                
                if (!supabase || !supabase.auth) {
                    throw new Error('Failed to initialize Supabase client');
                }
                
                addDebugInfo('Supabase client initialized successfully');
                
                // Load user data
                loadUserData();
                
                // Setup sign out button
                document.getElementById('signOut').addEventListener('click', async (e) => {
                    e.preventDefault();
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        console.error('Error signing out:', error.message);
                    } else {
                        // Reset the redirect time tracker
                        localStorage.removeItem('authRedirectTime');
                        window.location.href = '/auth.html';
                    }
                });
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showLoadingMessage('Failed to initialize the dashboard: ' + error.message, true);
                document.getElementById('loadingDebug').style.display = 'block';
            }
        }
        
        // Check authentication and load user data
        async function loadUserData() {
            try {
                // Show loading message
                showLoadingMessage('Checking your authentication...');
                
                // Get session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    throw sessionError;
                }
                
                if (!session) {
                    addDebugInfo('No active session found');
                    showLoadingMessage('You are not signed in. Redirecting to authentication page...', true);
                    
                    // Wait to display the message
                    setTimeout(() => {
                        if (!redirectAttempted) {
                            redirectAttempted = true;
                            localStorage.setItem('authRedirectTime', Date.now().toString());
                            window.location.href = '/auth.html';
                        }
                    }, 2000);
                    return;
                }
                
                addDebugInfo(`Session found for user: ${session.user.id}`);
                showLoadingMessage('Authentication successful! Loading your data...');
                
                try {
                    // Try to get the user profile
                    const { data: profile, error: profileError } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (profileError) {
                        addDebugInfo(`Profile fetch error: ${profileError.message}`);
                        // Even if profile fetch fails, show a basic dashboard with a friendly name
                        const userEmail = session.user.email || 'User';
                        const displayName = formatUserName(userEmail);
                        document.getElementById('userName').textContent = displayName;
                    } else {
                        // Update UI with user data - prioritize full_name, then display_name, then friendly email format
                        const displayName = profile.full_name || profile.display_name || formatUserName(session.user.email) || 'User';
                        document.getElementById('userName').textContent = displayName;
                        addDebugInfo('Profile data loaded successfully');
                    }
                    
                    // Load box league data
                    await loadBoxLeagueData(session.user.id);
                    
                    // We got this far, so authentication works
                    showBasicDashboard(session);
                    
                } catch (dataError) {
                    addDebugInfo(`Data loading error: ${dataError.message}`);
                    // If we fail to get profile but have a session, still show a basic dashboard
                    showBasicDashboard(session);
                }
            } catch (error) {
                console.error('Error checking authentication:', error);
                addDebugInfo(`Authentication error: ${error.message}`);
                document.getElementById('loadingDebug').style.display = 'block';
                document.getElementById('goToAuth').style.display = 'block';
                showLoadingMessage('Failed to authenticate. Please try signing in again.', true);
            }
        }
        
        // Helper function: Format email to a more user-friendly display name
        function formatUserName(email) {
            if (!email || typeof email !== 'string') return 'User';
            
            // Extract the part before @ if it's an email
            if (email.includes('@')) {
                const username = email.split('@')[0];
                
                // Handle common username patterns
                if (username.includes('.')) {
                    // Convert firstname.lastname to Firstname Lastname
                    return username.split('.')
                        .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                        .join(' ');
                } else if (username.match(/[A-Z]/)) {
                    // Handle camelCase or PascalCase (e.g., johnDoe -> John Doe)
                    return username
                        .replace(/([A-Z])/g, ' $1')
                        .trim()
                        .split(' ')
                        .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                        .join(' ');
                } else {
                    // Just capitalize the first letter
                    return username.charAt(0).toUpperCase() + username.slice(1);
                }
            }
            
            // Return original if not an email
            return email;
        }
        
        // Load Box League Data
        async function loadBoxLeagueData(userId) {
            try {
                // First get box leagues user is part of
                const { data: leagues, error: leaguesError } = await supabase
                    .from('box_leagues')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (leaguesError) {
                    throw leaguesError;
                }
                
                if (!leagues || leagues.length === 0) {
                    addDebugInfo('No box leagues found');
                    
                    // Show message in league table container
                    document.getElementById('leagueTableContainer').innerHTML = `
                        <div class="alert alert-info">
                            You are not currently part of any box leagues.
                        </div>
                    `;
                    
                    document.getElementById('statusFilter').style.display = 'none';
                    document.getElementById('leagueSelector').style.display = 'none';
                    document.getElementById('boxSelector').style.display = 'none';
                    document.getElementById('upcomingMatches').innerHTML = '<p>No upcoming matches.</p>';
                    document.getElementById('matchResults').innerHTML = '<p>No match results available.</p>';
                    return;
                }
                
                // Create status filter
                createStatusFilter(leagues);
                
                // Default to showing active leagues
                filterLeaguesByStatus('active', leagues);
                
            } catch (error) {
                console.error('Error loading box league data:', error);
                document.getElementById('leagueTableContainer').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading box league data: ${error.message}
                    </div>
                `;
            }
        }
        
        // Create status filter buttons
        function createStatusFilter(leagues) {
            const statusFilter = document.getElementById('statusFilter');
            
            // Extract all unique statuses from leagues
            const statuses = [...new Set(leagues.map(league => league.status || 'unknown'))];
            
            // Ensure we have our standard statuses, even if no leagues currently have them
            const standardStatuses = ['active', 'upcoming', 'completed', 'cancelled'];
            standardStatuses.forEach(status => {
                if (!statuses.includes(status)) {
                    statuses.push(status);
                }
            });
            
            // Get icons for each status
            const statusIcons = {
                active: '<i class="fas fa-play-circle me-1"></i>',
                upcoming: '<i class="fas fa-calendar-alt me-1"></i>',
                completed: '<i class="fas fa-flag-checkered me-1"></i>',
                cancelled: '<i class="fas fa-ban me-1"></i>',
                all: '<i class="fas fa-th-list me-1"></i>'
            };
            
            // Create filter buttons
            const filterHTML = `
                <label class="form-label d-block mb-2">Filter by Status:</label>
                <div class="status-filters">
                    <button class="status-filter-btn active" data-status="active">${statusIcons.active || ''}Active</button>
                    <button class="status-filter-btn" data-status="upcoming">${statusIcons.upcoming || ''}Upcoming</button>
                    <button class="status-filter-btn" data-status="completed">${statusIcons.completed || ''}Completed</button>
                    <button class="status-filter-btn" data-status="all">${statusIcons.all || ''}All</button>
                </div>
            `;
            
            statusFilter.innerHTML = filterHTML;
            
            // Add event listeners to filter buttons
            document.querySelectorAll('.status-filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.status-filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Apply filter
                    const status = this.getAttribute('data-status');
                    filterLeaguesByStatus(status, leagues);
                });
            });
        }
        
        // Filter leagues by status and update the league selector
        function filterLeaguesByStatus(status, allLeagues) {
            let filteredLeagues;
            
            if (status === 'all') {
                filteredLeagues = allLeagues;
            } else {
                filteredLeagues = allLeagues.filter(league => 
                    league.status === status || 
                    // Handle case where status might be null or undefined
                    (status === 'active' && (!league.status || league.status === ''))
                );
            }
            
            // If no leagues match the filter, show a message
            if (filteredLeagues.length === 0) {
                document.getElementById('leagueSelector').innerHTML = `
                    <div class="alert alert-info">
                        No leagues found with status: ${status}
                    </div>
                `;
                document.getElementById('boxSelector').style.display = 'none';
                document.getElementById('leagueTableContainer').innerHTML = '';
                document.getElementById('upcomingMatches').innerHTML = '<p>No upcoming matches.</p>';
                document.getElementById('matchResults').innerHTML = '<p>No match results available.</p>';
                return;
            }
            
            // Create league selector with filtered leagues
            createLeagueSelector(filteredLeagues);
            
            // Load boxes for the first filtered league
            loadBoxesForLeague(filteredLeagues[0].id);
        }
        
        // Create league selector dropdown
        function createLeagueSelector(leagues) {
            const leagueSelector = document.getElementById('leagueSelector');
            
            const selectHTML = `
                <label for="leagueSelect" class="form-label">Select League:</label>
                <select id="leagueSelect" class="form-select" aria-label="Select a league">
                    ${leagues.map(league => {
                        const statusBadge = league.status ? 
                            `<span class="badge bg-${getStatusColor(league.status)}">${capitalizeFirstLetter(league.status)}</span>` : 
                            '';
                        return `<option value="${league.id}">${league.name || 'Unnamed League'} ${statusBadge}</option>`;
                    }).join('')}
                </select>
                <small class="form-text text-muted mt-1">Select a league to view its boxes and matches</small>
            `;
            
            leagueSelector.innerHTML = selectHTML;
            
            // Add event listener for change
            document.getElementById('leagueSelect').addEventListener('change', function() {
                loadBoxesForLeague(this.value);
            });
        }
        
        // Helper function to get color for status badge
        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'active': return 'success';
                case 'upcoming': return 'primary';
                case 'completed': return 'secondary';
                case 'cancelled': return 'danger';
                default: return 'info';
            }
        }
        
        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Load boxes for a specific league
        async function loadBoxesForLeague(leagueId) {
            try {
                console.log('Loading boxes for league ID:', leagueId);
                
                // Show loading indicator in box selector
                document.getElementById('boxSelector').innerHTML = `
                    <label for="boxSelect" class="form-label">Select Box:</label>
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Loading boxes...</span>
                    </div>
                `;
                
                // Get boxes for the selected league
                const { data: boxes, error: boxesError } = await supabase
                    .from('box_league_boxes')
                    .select('*')
                    .eq('league_id', leagueId);
                
                if (boxesError) {
                    throw boxesError;
                }
                
                if (!boxes || boxes.length === 0) {
                    addDebugInfo('No boxes found for league');
                    document.getElementById('boxSelector').innerHTML = `
                        <div class="alert alert-info">
                            No boxes found for this league.
                        </div>
                    `;
                    document.getElementById('leagueTableContainer').innerHTML = `
                        <div class="alert alert-info">
                            <h4>No Box Data</h4>
                            <p>This league doesn't have any boxes configured yet.</p>
                        </div>
                    `;
                    document.getElementById('upcomingMatches').innerHTML = '<p>No upcoming matches.</p>';
                    document.getElementById('matchResults').innerHTML = '<p>No match results available.</p>';
                    return;
                }
                
                // Create box selector
                createBoxSelector(boxes);
                
                // For the first box, get teams and matches
                await loadBoxDetails(boxes[0].id);
                
            } catch (error) {
                console.error('Error loading boxes for league:', error);
                document.getElementById('boxSelector').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error Loading Boxes</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                document.getElementById('leagueTableContainer').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading boxes: ${error.message}
                    </div>
                `;
            }
        }
        
        // Create box selector dropdown
        function createBoxSelector(boxes) {
            const boxSelector = document.getElementById('boxSelector');
            
            const selectHTML = `
                <label for="boxSelect" class="form-label">Select Box:</label>
                <select id="boxSelect" class="form-select" aria-label="Select a box">
                    ${boxes.map(box => `<option value="${box.id}">${box.name || 'Unnamed Box'}</option>`).join('')}
                </select>
                <small class="form-text text-muted mt-1">Select a box to view teams and matches</small>
            `;
            
            boxSelector.innerHTML = selectHTML;
            
            // Add event listener for change
            document.getElementById('boxSelect').addEventListener('change', function() {
                loadBoxDetails(this.value);
            });
        }
        
        // Load details for a specific box
        async function loadBoxDetails(boxId) {
            try {
                console.log('Loading box details for box ID:', boxId);
                
                // Get teams for the box
                const { data: teams, error: teamsError } = await supabase
                    .from('box_league_teams')
                    .select('*')
                    .eq('box_id', boxId);
                
                if (teamsError) {
                    console.error('Error fetching teams:', teamsError);
                    throw teamsError;
                }
                
                console.log('Retrieved teams:', teams?.length || 0);
                
                // Get matches for the box
                const { data: matches, error: matchesError } = await supabase
                    .from('box_league_matches')
                    .select('*')
                    .eq('box_id', boxId);
                
                if (matchesError) {
                    console.error('Error fetching matches:', matchesError);
                    throw matchesError;
                }
                
                console.log('Retrieved matches:', matches?.length || 0);
                
                // Validate teams data
                if (!teams || !Array.isArray(teams)) {
                    throw new Error('Teams data is not valid: ' + JSON.stringify(teams));
                }
                
                // Validate team names
                teams.forEach((team, index) => {
                    if (!team.name) {
                        console.warn(`Team at index ${index} has no name:`, team);
                        team.name = `Team ${index + 1}`;
                    }
                });
                
                // Create league table
                createLeagueTable(teams, matches);
                
                // Create upcoming matches
                createUpcomingMatches(teams, matches);
                
                // Create match results
                createMatchResults(teams, matches);
                
            } catch (error) {
                console.error('Error loading box details:', error);
                document.getElementById('leagueTableContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error loading box details</h4>
                        <p>${error.message}</p>
                        <details>
                            <summary>Technical Details</summary>
                            <pre class="mt-2" style="font-size: 0.8rem; max-height: 150px; overflow: auto;">${error.stack || 'No stack trace available'}</pre>
                        </details>
                        <button class="btn btn-sm btn-outline-primary mt-3" onclick="window.location.reload()">Refresh Page</button>
                    </div>
                `;
                document.getElementById('upcomingMatches').innerHTML = '<p>Failed to load match data.</p>';
                document.getElementById('matchResults').innerHTML = '<p>Failed to load match data.</p>';
            }
        }
        
        // Create league table
        function createLeagueTable(teams, matches) {
            if (!teams || teams.length === 0) {
                document.getElementById('leagueTableContainer').innerHTML = '<p>No teams found for this box.</p>';
                return;
            }
            
            try {
                // Sort teams by calculated points
                const sortedTeams = teams.sort((a, b) => {
                    const pointsA = calculatePoints(a.id, matches);
                    const pointsB = calculatePoints(b.id, matches);
                    return pointsB - pointsA;
                });
                
                // Create table with headers
                let tableHTML = `
                    <div class="league-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th>Pts</th>
                                    ${sortedTeams.map(team => {
                                        try {
                                            return `<th>${getInitials(team.name || 'Unknown')}</th>`;
                                        } catch (e) {
                                            console.error('Error in team header:', team, e);
                                            return '<th>??</th>';
                                        }
                                    }).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Create table rows
                sortedTeams.forEach((team, index) => {
                    try {
                        const playerNames = getPlayerNames(team.name);
                        tableHTML += `
                            <tr>
                                <td class="team-name">${index + 1}. ${playerNames}</td>
                                <td><strong>${calculatePoints(team.id, matches)}</strong></td>
                        `;
                        
                        // Create cells for each opponent
                        sortedTeams.forEach(opponent => {
                            try {
                                if (team.id === opponent.id) {
                                    tableHTML += '<td>â€”</td>';
                                } else {
                                    const matchResult = getMatchResult(team.id, opponent.id, matches);
                                    tableHTML += `<td>
                                        <div class="match-result ${matchResult.class}" 
                                             data-team1="${team.id}" 
                                             data-team2="${opponent.id}"
                                             data-match-id="${matchResult.matchId || ''}">
                                            ${matchResult.text}
                                        </div>
                                    </td>`;
                                }
                            } catch (e) {
                                console.error('Error in opponent cell:', team, opponent, e);
                                tableHTML += '<td>ERR</td>';
                            }
                        });
                        
                        tableHTML += '</tr>';
                    } catch (e) {
                        console.error('Error in team row:', team, e);
                        tableHTML += `<tr><td colspan="${2 + sortedTeams.length}">Error loading team data</td></tr>`;
                    }
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('leagueTableContainer').innerHTML = tableHTML;
                
                // Add event listeners to match-result divs
                document.querySelectorAll('.match-result').forEach(el => {
                    el.addEventListener('click', handleMatchClick);
                });
            } catch (error) {
                console.error('Error creating league table:', error);
                document.getElementById('leagueTableContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Error creating league table</h4>
                        <p>${error.message}</p>
                        <pre class="mt-2" style="font-size: 0.8rem; max-height: 100px; overflow: auto;">${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        // Create upcoming matches list
        function createUpcomingMatches(teams, matches) {
            // Filter for upcoming/scheduled matches
            const upcomingMatches = matches.filter(match => 
                !match.is_completed && match.scheduled_date
            );
            
            let upcomingHTML = '';
            
            if (upcomingMatches.length === 0) {
                upcomingHTML = '<p class="placeholder-text">No upcoming matches scheduled.</p>';
            } else {
                // Sort by date
                upcomingMatches.sort((a, b) => 
                    new Date(a.scheduled_date) - new Date(b.scheduled_date)
                );
                
                upcomingMatches.forEach(match => {
                    const team1 = teams.find(t => t.id === match.team1_id);
                    const team2 = teams.find(t => t.id === match.team2_id);
                    
                    if (team1 && team2) {
                        const team1Names = getPlayerNames(team1.name);
                        const team2Names = getPlayerNames(team2.name);
                        
                        upcomingHTML += `
                            <div class="match-card" data-match-id="${match.id}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="match-date">${formatDate(match.scheduled_date)}</div>
                                    <span class="match-status status-scheduled">Scheduled</span>
                                </div>
                                <div class="team-names">
                                    <div class="team">${team1Names}</div>
                                    <div class="vs">vs</div>
                                    <div class="team">${team2Names}</div>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            document.getElementById('upcomingMatches').innerHTML = upcomingHTML;
            
            // Add event listeners
            document.querySelectorAll('#upcomingMatches .match-card').forEach(el => {
                el.addEventListener('click', () => {
                    const matchId = el.getAttribute('data-match-id');
                    handleMatchCardClick(matchId, matches, teams);
                });
            });
        }
        
        // Create match results list
        function createMatchResults(teams, matches) {
            // Filter for completed matches
            const completedMatches = matches.filter(match => match.is_completed);
            
            let resultsHTML = '';
            
            if (completedMatches.length === 0) {
                resultsHTML = '<p class="placeholder-text">No completed matches yet.</p>';
            } else {
                // Sort by date, most recent first
                completedMatches.sort((a, b) => 
                    new Date(b.completed_date || b.scheduled_date) - new Date(a.completed_date || a.scheduled_date)
                );
                
                completedMatches.forEach(match => {
                    const team1 = teams.find(t => t.id === match.team1_id);
                    const team2 = teams.find(t => t.id === match.team2_id);
                    
                    if (team1 && team2) {
                        const team1Names = getPlayerNames(team1.name);
                        const team2Names = getPlayerNames(team2.name);
                        const team1Score = match.team1_score;
                        const team2Score = match.team2_score;
                        const team1SetScores = match.team1_set_scores || [];
                        const team2SetScores = match.team2_set_scores || [];
                        
                        resultsHTML += `
                            <div class="match-card" data-match-id="${match.id}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="match-date">${formatDate(match.completed_date || match.scheduled_date)}</div>
                                    ${match.is_walkover ? 
                                        '<span class="match-status status-walkover">Walkover</span>' : 
                                        '<span class="match-status status-completed">Completed</span>'}
                                </div>
                                <div class="team-names">
                                    <div class="team">${team1Names}</div>
                                    <div class="score">${team1Score} - ${team2Score}</div>
                                    <div class="team">${team2Names}</div>
                                </div>
                                ${formatSetScores(team1SetScores, team2SetScores)}
                            </div>
                        `;
                    }
                });
            }
            
            document.getElementById('matchResults').innerHTML = resultsHTML;
            
            // Add event listeners
            document.querySelectorAll('#matchResults .match-card').forEach(el => {
                el.addEventListener('click', () => {
                    const matchId = el.getAttribute('data-match-id');
                    handleMatchCardClick(matchId, matches, teams);
                });
            });
        }
        
        // Handle match click in league table
        function handleMatchClick(event) {
            const team1Id = this.getAttribute('data-team1');
            const team2Id = this.getAttribute('data-team2');
            const matchId = this.getAttribute('data-match-id');
            
            console.log(`Match clicked: ${team1Id} vs ${team2Id}, match ID: ${matchId}`);
            
            // TODO: Open match details modal or form
            alert(`Match detail view coming soon for ${team1Id} vs ${team2Id}`);
        }
        
        // Handle match card click
        function handleMatchCardClick(matchId, matches, teams) {
            const match = matches.find(m => m.id === matchId);
            
            if (!match) return;
            
            const team1 = teams.find(t => t.id === match.team1_id);
            const team2 = teams.find(t => t.id === match.team2_id);
            
            if (!team1 || !team2) return;
            
            const team1Names = getPlayerNames(team1.name);
            const team2Names = getPlayerNames(team2.name);
            
            console.log(`Match card clicked: ${team1Names} vs ${team2Names}`);
            
            // TODO: Open match details modal or form
            alert(`Match detail view coming soon for ${team1Names} vs ${team2Names}`);
        }
        
        // Helper function: Get match result for display in the grid
        function getMatchResult(team1Id, team2Id, matches) {
            // Find match between these teams
            const match = matches.find(m => 
                (m.team1_id === team1Id && m.team2_id === team2Id) || 
                (m.team1_id === team2Id && m.team2_id === team1Id)
            );
            
            if (!match) {
                // No match exists
                return { text: '+', class: 'match-unplayed', matchId: null };
            }
            
            if (!match.is_completed) {
                // Match exists but not completed
                if (match.scheduled_date) {
                    return { text: 'â°', class: 'match-scheduled', matchId: match.id };
                } else {
                    return { text: '+', class: 'match-unplayed', matchId: match.id };
                }
            }
            
            // Match is completed
            // Check if it's a walkover
            if (match.is_walkover) {
                // Determine if this team won the walkover
                const isWinner = (match.team1_id === team1Id && match.team1_score > match.team2_score) ||
                                (match.team2_id === team1Id && match.team2_score > match.team1_score);
                
                if (isWinner) {
                    return { text: 'WO', class: 'match-walkover-win', matchId: match.id };
                } else {
                    return { text: 'WO', class: 'match-walkover-loss', matchId: match.id };
                }
            }
            
            // Regular completed match
            const isWinner = (match.team1_id === team1Id && match.team1_score > match.team2_score) ||
                            (match.team2_id === team1Id && match.team2_score > match.team1_score);
            
            if (isWinner) {
                return { text: 'W', class: 'match-win', matchId: match.id };
            } else {
                return { text: 'L', class: 'match-loss', matchId: match.id };
            }
        }
        
        // Helper function: Calculate points for a team
        function calculatePoints(teamId, matches) {
            let points = 0;
            
            // Filter for matches involving this team and that are completed
            const teamMatches = matches.filter(match => 
                (match.team1_id === teamId || match.team2_id === teamId) && match.is_completed
            );
            
            for (const match of teamMatches) {
                const isTeam1 = match.team1_id === teamId;
                
                // Special handling for walkover matches
                if (match.is_walkover) {
                    // For walkover, winning team gets 4 points, losing team gets 0
                    if ((isTeam1 && match.team1_score > match.team2_score) || 
                        (!isTeam1 && match.team2_score > match.team1_score)) {
                        points += 4;
                    }
                    continue;
                }
                
                // Get set scores if available
                const team1Sets = match.team1_set_scores || [];
                const team2Sets = match.team2_set_scores || [];
                
                if (team1Sets.length === 0 || team2Sets.length === 0) {
                    // Fall back to match score if set scores are missing
                    if (isTeam1) {
                        if (match.team1_score > match.team2_score) {
                            points += 4; // Default points for win
                        } else {
                            points += 1; // Default points for loss
                        }
                    } else {
                        if (match.team2_score > match.team1_score) {
                            points += 4; // Default points for win
                        } else {
                            points += 1; // Default points for loss
                        }
                    }
                    continue;
                }
                
                // Count sets won by each team
                let team1SetsWon = 0;
                let team2SetsWon = 0;
                
                for (let i = 0; i < Math.min(team1Sets.length, team2Sets.length); i++) {
                    if (team1Sets[i] > team2Sets[i]) {
                        team1SetsWon++;
                    } else if (team2Sets[i] > team1Sets[i]) {
                        team2SetsWon++;
                    }
                }
                
                // Apply scoring system
                if (isTeam1) {
                    if (team1SetsWon === 2 && team2SetsWon === 0) {
                        points += 5; // 2-0 win
                    } else if (team1SetsWon === 2 && team2SetsWon === 1) {
                        points += 4; // 2-1 win
                    } else if (team1SetsWon === 1 && team2SetsWon === 2) {
                        points += 2; // 1-2 loss
                    } else if (team1SetsWon === 0 && team2SetsWon === 2) {
                        points += 1; // 0-2 loss
                    }
                } else {
                    if (team2SetsWon === 2 && team1SetsWon === 0) {
                        points += 5; // 2-0 win
                    } else if (team2SetsWon === 2 && team1SetsWon === 1) {
                        points += 4; // 2-1 win
                    } else if (team2SetsWon === 1 && team1SetsWon === 2) {
                        points += 2; // 1-2 loss
                    } else if (team2SetsWon === 0 && team1SetsWon === 2) {
                        points += 1; // 0-2 loss
                    }
                }
            }
            
            return points;
        }
        
        // Helper function: Get initials from team name
        function getInitials(name) {
            // Check if name is undefined or null
            if (!name) return 'NA';
            
            try {
                // Pattern: "First1 Last1 & First2 Last2" or similar variations
                const components = name.split(' & ');
                if (components.length >= 2) {
                    // Extract first names from each part
                    const firstPerson = components[0].trim().split(' ')[0] || '';
                    const secondPerson = components[1].trim().split(' ')[0] || '';
                    return `${firstPerson.slice(0, 3)}/${secondPerson.slice(0, 3)}`;
                } else {
                    // Handle single name or other formats
                    const words = name.trim().split(' ');
                    if (words.length >= 2) {
                        return (words[0][0] + words[1][0]).toUpperCase();
                    } else if (name.length >= 2) {
                        return name.substring(0, 2).toUpperCase();
                    } else {
                        return name.toUpperCase();
                    }
                }
            } catch (error) {
                console.error('Error getting initials from name:', name, error);
                return 'NA'; // Return a generic placeholder for invalid inputs
            }
        }
        
        // Helper function: Extract player names from team name
        function getPlayerNames(name) {
            if (!name) return 'Unknown Team';
            
            try {
                const components = name.split(' & ');
                if (components.length >= 2) {
                    // Extract first names from each part
                    const firstPerson = components[0].trim().split(' ')[0] || '';
                    const secondPerson = components[1].trim().split(' ')[0] || '';
                    return `${firstPerson} & ${secondPerson}`;
                } else {
                    return name; // Return original if not in expected format
                }
            } catch (error) {
                console.error('Error extracting player names:', name, error);
                return name;
            }
        }
        
        // Helper function: Format date
        function formatDate(dateString) {
            if (!dateString) return 'Date not set';
            
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        }
        
        // Helper function: Format set scores
        function formatSetScores(team1Sets, team2Sets) {
            if (!team1Sets || !team2Sets || team1Sets.length === 0 || team2Sets.length === 0) {
                return '';
            }
            
            const setScores = [];
            for (let i = 0; i < Math.min(team1Sets.length, team2Sets.length); i++) {
                setScores.push(`${team1Sets[i]}-${team2Sets[i]}`);
            }
            
            return `<div class="set-scores text-center mt-1 text-secondary">Sets: ${setScores.join(', ')}</div>`;
        }
        
        // Show a basic dashboard even if profile data fails
        function showBasicDashboard(session) {
            // Set placeholder content
            document.getElementById('matchStats').innerHTML = '<p>Your match data is not available yet.</p>';
            document.getElementById('recentMatches').innerHTML = '<p>No recent matches found.</p>';
            document.getElementById('boxLeagueStatus').innerHTML = '<p>Box league data is not available yet.</p>';
            
            // Run a simple test query to verify connection
            testSupabaseConnection(session);
            
            // Show dashboard content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }
        
        // Function to test Supabase connection
        async function testSupabaseConnection(session) {
            const testElement = document.getElementById('connectionTest');
            
            try {
                // Display authentication info
                let testHtml = `
                    <h4>Authentication Status</h4>
                    <p><strong>Status:</strong> <span class="text-success">Authenticated</span></p>
                    <p><strong>User ID:</strong> ${session.user.id}</p>
                    <p><strong>Provider:</strong> ${session.user.app_metadata.provider || 'Unknown'}</p>
                `;
                
                // Run a simple query to test database access
                testHtml += `<h4>Database Connection Test</h4>`;
                
                try {
                    // Try to query a random table to verify permissions work
                    const { count, error: countError } = await supabase
                        .from('profiles')
                        .select('*', { count: 'exact', head: true });
                        
                    if (countError) {
                        testHtml += `<p><strong>Database Access:</strong> <span class="text-danger">Failed</span> - ${countError.message}</p>`;
                        testHtml += `<div class="alert alert-warning mt-3">
                            <strong>Note:</strong> Your account may have limited database access. Some features may not be available.
                        </div>`;
                    } else {
                        testHtml += `<p><strong>Database Access:</strong> <span class="text-success">Success</span> - Found ${count} profiles</p>`;
                        testHtml += `<div class="alert alert-success mt-3">
                            <strong>Connection Test Complete:</strong> Your authentication is working correctly!
                        </div>`;
                    }
                } catch (dbError) {
                    testHtml += `<p><strong>Database Access:</strong> <span class="text-danger">Failed</span> - ${dbError.message}</p>`;
                }
                
                testElement.innerHTML = testHtml;
                
            } catch (error) {
                testElement.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Connection Test Failed</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html> 