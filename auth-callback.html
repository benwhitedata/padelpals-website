<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Pals - Authentication</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Load the config loader for reliable configuration -->
    <script src="config-loader.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --dark-blue: #1a2238;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f9f9f9;
        }
        .auth-container {
            text-align: center;
            color: #1a2238;
            max-width: 400px;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a2238;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 5px;
            text-align: left;
        }
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #1a2238;
            text-decoration: none;
            padding: 10px 15px;
            background-color: #f1f1f1;
            border-radius: 5px;
        }
        .back-link:hover {
            background-color: #e5e5e5;
        }
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
        }
        .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .warning-message {
            background-color: #fff3cd;
            color: #856404;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="auth-container" id="authContainer">
        <div class="spinner"></div>
        <h2>Completing sign in...</h2>
        <p>Please wait while we authenticate your account.</p>
        <div id="statusMessage" class="info-message" style="display: none;"></div>
        <div id="debugContainer" style="margin-top: 20px; text-align: left; display: block;">
            <h4>Debug Information:</h4>
            <pre id="debugInfo" style="background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 300px; overflow: auto;"></pre>
            <div id="actionButtons" style="margin-top: 15px;">
                <button id="continueToAuth" style="display: none; padding: 8px 16px; background-color: #1a2238; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Continue to Auth Page</button>
                <button id="continueToDashboard" style="display: none; padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Continue to Dashboard</button>
            </div>
        </div>
    </div>

    <script>
        // Define global variables and functions
        let debugInfoElement;
        let statusMessageElement;
        let spinnerElement;
        
        // Debug utility function
        function addDebugInfo(message) {
            console.log(message);
            if (debugInfoElement) {
                debugInfoElement.innerHTML += message + '<br>';
            }
        }
        
        // Status message utility
        function showStatusMessage(message, type = 'info') {
            if (statusMessageElement) {
                statusMessageElement.innerHTML = message;
                statusMessageElement.className = type + '-message message';
                statusMessageElement.style.display = 'block';
            }
        }
        
        // Function to show error and hide spinner
        function showError(message) {
            if (spinnerElement) {
                spinnerElement.style.display = 'none';
            }
            showStatusMessage(message, 'error');
            
            // Show button to continue to auth page
            const continueBtn = document.getElementById('continueToAuth');
            if (continueBtn) {
                continueBtn.style.display = 'inline-block';
                continueBtn.addEventListener('click', function() {
                    window.location.href = '/auth.html';
                });
            }
        }
        
        // Initialize page elements
        document.addEventListener('DOMContentLoaded', function() {
            debugInfoElement = document.getElementById('debugInfo');
            statusMessageElement = document.getElementById('statusMessage');
            spinnerElement = document.querySelector('.spinner');
            
            addDebugInfo('Waiting for configuration to load...');
            
            // The auth callback button should redirect to auth.html
            const continueBtn = document.getElementById('continueToAuth');
            if (continueBtn) {
                continueBtn.addEventListener('click', function() {
                    window.location.href = '/auth.html';
                });
            }
            
            // The dashboard button should redirect to dashboard.html
            const dashboardBtn = document.getElementById('continueToDashboard');
            if (dashboardBtn) {
                dashboardBtn.addEventListener('click', function() {
                    window.location.href = '/dashboard.html';
                });
            }
        });
        
        // Listen for the configLoaded event from config-loader.js
        document.addEventListener('configLoaded', function() {
            addDebugInfo('Configuration loaded successfully');
            addDebugInfo(`Supabase URL: ${window.config.supabaseUrl}`);
            addDebugInfo(`API key available: ${window.config.supabaseKey ? 'Yes' : 'No'}`);
            
            // Process authentication with the loaded config
            handleAuthCallback();
        });
        
        // Function to handle the authentication callback
        async function handleAuthCallback() {
            try {
                if (!window.config || !window.config.supabaseKey) {
                    throw new Error('Supabase credentials not configured properly');
                }
                
                // Initialize Supabase client
                const supabase = window.supabase.createClient(
                    window.config.supabaseUrl, 
                    window.config.supabaseKey
                );
                
                // Check if supabase.auth exists
                if (!supabase || !supabase.auth) {
                    throw new Error('Supabase client initialization failed. Auth module not available.');
                }
                
                addDebugInfo('Processing authentication callback...');
                
                // Check for error parameters in the URL
                const urlParams = new URLSearchParams(window.location.search);
                
                // Handle OAuth errors from the query string
                if (urlParams.has('error')) {
                    const error = urlParams.get('error');
                    const errorCode = urlParams.get('error_code');
                    const errorDesc = urlParams.get('error_description') || 'Unknown error';
                    addDebugInfo(`Error: ${error} (${errorCode}): ${errorDesc}`);
                    throw new Error(`${error} (${errorCode}): ${errorDesc}`);
                }
                
                // Handle the hash fragment if present (some OAuth providers use it)
                if (window.location.hash) {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    if (hashParams.has('error')) {
                        const error = hashParams.get('error');
                        const errorDesc = hashParams.get('error_description') || 'Unknown error';
                        addDebugInfo(`Error in hash: ${error}: ${errorDesc}`);
                        throw new Error(`${error}: ${errorDesc}`);
                    }
                }
                
                // First, check if we have a code in the URL (standard OAuth callback)
                if (urlParams.has('code')) {
                    const code = urlParams.get('code');
                    const state = urlParams.get('state');
                    
                    addDebugInfo(`Found code parameter in URL: ${code.substring(0, 10)}...`);
                    addDebugInfo(`State parameter: ${state ? 'Present' : 'Missing'}`);
                    
                    try {
                        addDebugInfo('Attempting to exchange code for session...');
                        const { data, error } = await supabase.auth.exchangeCodeForSession(code);
                        
                        if (error) {
                            addDebugInfo(`Error exchanging code: ${error.message}`);
                            throw error;
                        }
                        
                        if (data?.session) {
                            addDebugInfo('Successfully exchanged code for session!');
                            
                            // Explicitly set the session
                            await supabase.auth.setSession({
                                access_token: data.session.access_token,
                                refresh_token: data.session.refresh_token
                            });
                            
                            addDebugInfo('Session set explicitly');
                            showStatusMessage('Authentication successful! Redirecting to dashboard...', 'success');
                            
                            // Get the redirect URL from the query parameters or default to dashboard
                            const redirectUrl = urlParams.get('redirect_to') || '/dashboard.html';
                            addDebugInfo(`Redirecting to: ${redirectUrl}`);
                            
                            // Redirect to the dashboard
                            window.location.href = redirectUrl;
                            
                            return;
                        }
                    } catch (error) {
                        addDebugInfo(`Session exchange error: ${error.message}`);
                        throw error;
                    }
                } else {
                    // Check for existing session
                    addDebugInfo('Checking for existing session...');
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    
                    if (sessionError) {
                        addDebugInfo(`Session error: ${sessionError.message}`);
                        throw sessionError;
                    }
                    
                    if (session) {
                        addDebugInfo('Existing session found, redirecting to dashboard');
                        showStatusMessage('You are already signed in! Redirecting to dashboard...', 'success');
                        
                        // Show dashboard button
                        const dashboardBtn = document.getElementById('continueToDashboard');
                        if (dashboardBtn) {
                            dashboardBtn.style.display = 'inline-block';
                        }
                        
                        // Hide spinner
                        if (spinnerElement) {
                            spinnerElement.style.display = 'none';
                        }
                        
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = '/dashboard.html';
                        }, 2000);
                        
                        return;
                    } else {
                        addDebugInfo('No session found, redirecting to auth page');
                        throw new Error('No authentication code or session found. Please try signing in again.');
                    }
                }
            } catch (error) {
                console.error('Authentication error:', error);
                addDebugInfo(`Authentication error: ${error.message}`);
                showError(`Authentication failed: ${error.message}`);
                
                // Show the continue to auth button
                const continueBtn = document.getElementById('continueToAuth');
                if (continueBtn) {
                    continueBtn.style.display = 'inline-block';
                }
                
                // Hide spinner
                if (spinnerElement) {
                    spinnerElement.style.display = 'none';
                }
            }
        }
    </script>
</body>
</html> 