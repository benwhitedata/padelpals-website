<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Authentication - Padel Pals</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="Icon.png" type="image/png">
    <!-- Load Supabase JS and config loader -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config-loader.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --dark-blue: #1a2238;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            line-height: 1.6;
        }
        .fix-container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            margin-top: 50px;
        }
        .output-container {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            height: 250px;
            overflow-y: auto;
        }
        .btn-primary {
            background-color: var(--dark-blue);
            border-color: var(--dark-blue);
        }
        .btn-primary:hover {
            background-color: #2a3990;
            border-color: #2a3990;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1>Authentication Repair Tool</h1>
        <p>This page will repair authentication issues on the Padel Pals website.</p>
        
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Current Status</h5>
                <div id="status">Checking authentication status...</div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <button id="repairBtn" class="btn btn-primary w-100">Repair Authentication</button>
            </div>
            <div class="col-md-6">
                <button id="signOutBtn" class="btn btn-warning w-100">Clear Auth & Sign Out</button>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <button id="debugBtn" class="btn btn-secondary w-100">Go To Debug Page</button>
            </div>
            <div class="col-md-6">
                <button id="homeBtn" class="btn btn-success w-100">Go To Home Page</button>
            </div>
        </div>
        
        <div class="output-container" id="output">
            Initializing...
        </div>
    </div>
    
    <script>
        // Logging function
        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `[${timestamp}] ${message}<br>`;
            output.scrollTop = output.scrollHeight;
        }
        
        // Update status display
        function updateStatus(message, isSuccess = true) {
            const status = document.getElementById('status');
            status.className = `status ${isSuccess ? 'success' : 'error'}`;
            status.textContent = message;
        }
        
        // Check auth status
        async function checkAuth() {
            log('Checking authentication status...');
            
            try {
                if (!window.supabase || !window.supabase.createClient) {
                    updateStatus('Supabase library not properly loaded', false);
                    log('ERROR: Supabase library not properly loaded or initialized');
                    return false;
                }
                
                if (!window.config) {
                    updateStatus('Configuration not loaded', false);
                    log('ERROR: Configuration not loaded');
                    return false;
                }
                
                // Create a Supabase client
                const supabase = window.supabase.createClient(
                    window.config.supabaseUrl,
                    window.config.supabaseKey
                );
                
                // Check if auth module is available
                if (!supabase.auth) {
                    updateStatus('Supabase auth module not available', false);
                    log('ERROR: Supabase auth module not available');
                    return false;
                }
                
                // Check for session
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    updateStatus(`Authentication error: ${error.message}`, false);
                    log(`ERROR: ${error.message}`);
                    return false;
                }
                
                if (data.session) {
                    updateStatus(`Signed in as user ${data.session.user.id.substring(0, 8)}...`);
                    log(`Authenticated as user: ${data.session.user.id}`);
                    log(`Session expires: ${new Date(data.session.expires_at * 1000).toLocaleString()}`);
                    return true;
                } else {
                    updateStatus('Not signed in', false);
                    log('No active session found');
                    return false;
                }
            } catch (e) {
                updateStatus(`Error: ${e.message}`, false);
                log(`ERROR: ${e.message}`);
                return false;
            }
        }
        
        // Repair authentication
        async function repairAuth() {
            log('Repairing authentication...');
            
            try {
                // 1. Create a global Supabase instance
                if (!window.supabase || !window.supabase.createClient) {
                    log('ERROR: Supabase library not available');
                    return false;
                }
                
                window.globalSupabase = window.supabase.createClient(
                    window.config.supabaseUrl,
                    window.config.supabaseKey
                );
                
                log('Created global Supabase instance');
                
                // 2. Check for session with new instance
                const { data, error } = await window.globalSupabase.auth.getSession();
                
                if (error) {
                    log(`ERROR: ${error.message}`);
                    return false;
                }
                
                if (data.session) {
                    log(`Found valid session with user ID: ${data.session.user.id}`);
                    
                    // 3. Create and store fixed auth script
                    const fixScript = document.createElement('script');
                    fixScript.textContent = `
                    // Global fix for Supabase client
                    window.addEventListener('DOMContentLoaded', function() {
                        // Create global Supabase client available to all pages
                        if (window.supabase && window.config) {
                            console.log('Auth Fix: Creating global Supabase client');
                            window.globalSupabase = window.supabase.createClient(
                                window.config.supabaseUrl,
                                window.config.supabaseKey
                            );
                            
                            // Store in localStorage that we've applied the fix
                            localStorage.setItem('auth-fix-applied', 'true');
                            
                            // Check auth status
                            window.globalSupabase.auth.getSession().then(function(response) {
                                const { data, error } = response;
                                if (error) {
                                    console.error('Auth Fix: Error getting session', error);
                                } else if (data.session) {
                                    console.log('Auth Fix: Session found for user', data.session.user.id);
                                    
                                    // Update UI for signed-in user
                                    const navSignInLink = document.querySelector('#navSignIn');
                                    const navDashboardLink = document.querySelector('#navDashboard');
                                    const footerSignInLink = document.querySelector('#footerSignIn');
                                    const footerDashboardLink = document.querySelector('#footerDashboard');
                                    
                                    if (navSignInLink) {
                                        navSignInLink.textContent = 'Sign Out';
                                        navSignInLink.href = '#';
                                        navSignInLink.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            window.globalSupabase.auth.signOut().then(function() {
                                                window.location.reload();
                                            });
                                        });
                                    }
                                    
                                    if (navDashboardLink) {
                                        navDashboardLink.style.display = '';
                                    }
                                    
                                    if (footerSignInLink) {
                                        footerSignInLink.textContent = 'Sign Out';
                                        footerSignInLink.href = '#';
                                        footerSignInLink.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            window.globalSupabase.auth.signOut().then(function() {
                                                window.location.reload();
                                            });
                                        });
                                    }
                                    
                                    if (footerDashboardLink) {
                                        footerDashboardLink.style.display = '';
                                    }
                                } else {
                                    console.log('Auth Fix: No session found');
                                }
                            });
                        } else {
                            console.error('Auth Fix: Missing supabase or config objects');
                        }
                    });
                    `;
                    
                    document.body.appendChild(fixScript);
                    log('Applied authentication fix to current page');
                    localStorage.setItem('auth-fix-applied', 'true');
                    
                    // 4. Verify fix was applied
                    if (window.globalSupabase && window.globalSupabase.auth) {
                        updateStatus('Authentication fixed!');
                        log('Fix verified: Global Supabase client is working');
                        
                        setTimeout(() => {
                            log('Testing updated UI elements...');
                            const navSignInLink = document.querySelector('#navSignIn');
                            const navDashboardLink = document.querySelector('#navDashboard');
                            
                            if (navSignInLink) {
                                log(`Sign In link text: "${navSignInLink.textContent}"`);
                            }
                            
                            if (navDashboardLink) {
                                log(`Dashboard display: ${navDashboardLink.style.display}`);
                            }
                        }, 500);
                        
                        return true;
                    } else {
                        updateStatus('Fix applied but verification failed', false);
                        log('WARNING: Fix applied but global Supabase client not verified');
                        return false;
                    }
                } else {
                    updateStatus('No session to repair', false);
                    log('No active session to repair');
                    return false;
                }
            } catch (e) {
                updateStatus(`Repair failed: ${e.message}`, false);
                log(`ERROR during repair: ${e.message}`);
                return false;
            }
        }
        
        // Sign out and clear data
        async function signOut() {
            log('Signing out and clearing auth data...');
            
            try {
                if (window.globalSupabase) {
                    await window.globalSupabase.auth.signOut();
                    log('Signed out with global client');
                } else if (window.supabase && window.supabase.createClient) {
                    const supabase = window.supabase.createClient(
                        window.config.supabaseUrl,
                        window.config.supabaseKey
                    );
                    await supabase.auth.signOut();
                    log('Signed out with new client');
                }
                
                // Clear localStorage
                localStorage.clear();
                log('Local storage cleared');
                
                updateStatus('Signed out and cleared all data');
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
                return true;
            } catch (e) {
                updateStatus(`Sign out failed: ${e.message}`, false);
                log(`ERROR during sign out: ${e.message}`);
                
                // Try to clear localStorage anyway
                try {
                    localStorage.clear();
                    log('Local storage cleared despite error');
                } catch (err) {
                    log(`Failed to clear localStorage: ${err.message}`);
                }
                
                return false;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Page loaded');
            
            // Setup buttons
            document.getElementById('repairBtn').addEventListener('click', repairAuth);
            document.getElementById('signOutBtn').addEventListener('click', signOut);
            document.getElementById('debugBtn').addEventListener('click', () => window.location.href = 'debug-auth.html');
            document.getElementById('homeBtn').addEventListener('click', () => window.location.href = 'index.html');
        });
        
        // Wait for config to load
        document.addEventListener('configLoaded', function() {
            log('Configuration loaded');
            checkAuth();
        });
    </script>
</body>
</html> 