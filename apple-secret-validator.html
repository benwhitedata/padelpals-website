<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Secret Key Validator - Padel Pals</title>
    <link rel="icon" href="images/Icon.png" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4A90E2 0%, #1a2238 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #4A90E2;
        }
        .section.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .section.success {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        .section.warning {
            border-left-color: #ffc107;
            background: #fffef0;
        }
        .section h2 {
            color: #1a2238;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        .check-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 6px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .check-item.success::before {
            content: "‚úì";
            color: #28a745;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .check-item.error::before {
            content: "‚úó";
            color: #dc3545;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .check-item.warning::before {
            content: "‚ö†";
            color: #ffc107;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .check-item.info::before {
            content: "‚Ñπ";
            color: #4A90E2;
            font-weight: bold;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .check-item .label {
            font-weight: 600;
            min-width: 150px;
        }
        .check-item .value {
            flex: 1;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #4A90E2;
        }
        button {
            background: linear-gradient(135deg, #4A90E2 0%, #1a2238 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .json-view {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .json-key {
            color: #9cdcfe;
        }
        .json-string {
            color: #ce9178;
        }
        .json-number {
            color: #b5cea8;
        }
        .expected-values {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .expected-values h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }
        .expected-values ul {
            list-style: none;
            padding-left: 0;
        }
        .expected-values li {
            padding: 5px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Apple Secret Key Validator</h1>
            <p>Verify your Apple OAuth Secret Key (JWT) configuration</p>
        </div>
        <div class="content">
            <div class="section">
                <h2>Paste Your Secret Key</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    Paste the JWT secret key from Supabase Dashboard ‚Üí Authentication ‚Üí Providers ‚Üí Apple ‚Üí Secret Key (for OAuth)
                </p>
                <textarea id="secretKeyInput" placeholder="Paste your JWT secret here (should start with 'eyJ...')"></textarea>
                <button onclick="validateSecretKey()">Validate Secret Key</button>
            </div>

            <div class="expected-values" id="expectedValues" style="display: none;">
                <h3>Expected Values (Your Configuration)</h3>
                <ul>
                    <li><strong>Key ID:</strong> 7X94CKX99M</li>
                    <li><strong>Team ID:</strong> 783NB5H5V4</li>
                    <li><strong>Services ID:</strong> com.playpadelpals.padelpals362.signin</li>
                </ul>
            </div>

            <div id="validationResults"></div>
        </div>
    </div>

    <script>
        function base64UrlDecode(str) {
            // Add padding if needed
            let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
            while (base64.length % 4) {
                base64 += '=';
            }
            try {
                const decoded = atob(base64);
                return decoded;
            } catch (e) {
                throw new Error('Invalid base64 encoding');
            }
        }

        function parseJWT(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('JWT must have 3 parts (header.payload.signature)');
                }

                const header = JSON.parse(base64UrlDecode(parts[0]));
                const payload = JSON.parse(base64UrlDecode(parts[1]));

                return { header, payload, signature: parts[2] };
            } catch (e) {
                throw new Error(`Failed to parse JWT: ${e.message}`);
            }
        }

        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }

        function validateSecretKey() {
            const secretKey = document.getElementById('secretKeyInput').value.trim();
            const resultsDiv = document.getElementById('validationResults');
            const expectedDiv = document.getElementById('expectedValues');
            
            // Show expected values
            expectedDiv.style.display = 'block';

            // Clear previous results
            resultsDiv.innerHTML = '';

            if (!secretKey) {
                resultsDiv.innerHTML = `
                    <div class="section error">
                        <h2>‚ùå Error</h2>
                        <div class="check-item error">
                            <div class="value">Please paste your secret key</div>
                        </div>
                    </div>
                `;
                return;
            }

            // Basic format check
            if (!secretKey.startsWith('eyJ')) {
                resultsDiv.innerHTML = `
                    <div class="section error">
                        <h2>‚ùå Invalid Format</h2>
                        <div class="check-item error">
                            <div class="value">Secret key should start with "eyJ..." (JWT format).<br>
                            You may have pasted the raw .p8 file contents instead of the generated JWT.</div>
                        </div>
                    </div>
                `;
                return;
            }

            try {
                const { header, payload, signature } = parseJWT(secretKey);
                
                // Expected values
                const EXPECTED_KEY_ID = '7X94CKX99M';
                const EXPECTED_TEAM_ID = '783NB5H5V4';
                const EXPECTED_SERVICES_ID = 'com.playpadelpals.padelpals362.signin';

                let checks = [];
                let hasErrors = false;
                let hasWarnings = false;

                // Check JWT structure
                checks.push({
                    label: 'JWT Format',
                    value: 'Valid (3 parts: header.payload.signature)',
                    status: 'success'
                });

                // Check algorithm
                if (header.alg === 'ES256') {
                    checks.push({
                        label: 'Algorithm',
                        value: header.alg + ' (correct for Apple)',
                        status: 'success'
                    });
                } else {
                    checks.push({
                        label: 'Algorithm',
                        value: header.alg + ' (should be ES256 for Apple)',
                        status: 'error'
                    });
                    hasErrors = true;
                }

                // Check Key ID (kid) in header
                if (header.kid === EXPECTED_KEY_ID) {
                    checks.push({
                        label: 'Key ID (kid)',
                        value: header.kid + ' ‚úì Matches expected',
                        status: 'success'
                    });
                } else if (header.kid) {
                    checks.push({
                        label: 'Key ID (kid)',
                        value: header.kid + ' (expected: ' + EXPECTED_KEY_ID + ')',
                        status: 'error'
                    });
                    hasErrors = true;
                } else {
                    checks.push({
                        label: 'Key ID (kid)',
                        value: 'Missing in header',
                        status: 'error'
                    });
                    hasErrors = true;
                }

                // Check issuer (iss) - should be Team ID
                if (payload.iss === EXPECTED_TEAM_ID) {
                    checks.push({
                        label: 'Issuer (iss) / Team ID',
                        value: payload.iss + ' ‚úì Matches expected',
                        status: 'success'
                    });
                } else if (payload.iss) {
                    checks.push({
                        label: 'Issuer (iss) / Team ID',
                        value: payload.iss + ' (expected: ' + EXPECTED_TEAM_ID + ')',
                        status: 'error'
                    });
                    hasErrors = true;
                } else {
                    checks.push({
                        label: 'Issuer (iss) / Team ID',
                        value: 'Missing in payload',
                        status: 'error'
                    });
                    hasErrors = true;
                }

                // Check subject (sub) - should be Services ID
                if (payload.sub === EXPECTED_SERVICES_ID) {
                    checks.push({
                        label: 'Subject (sub) / Services ID',
                        value: payload.sub + ' ‚úì Matches expected',
                        status: 'success'
                    });
                } else if (payload.sub) {
                    checks.push({
                        label: 'Subject (sub) / Services ID',
                        value: payload.sub + ' (expected: ' + EXPECTED_SERVICES_ID + ')',
                        status: 'error'
                    });
                    hasErrors = true;
                } else {
                    checks.push({
                        label: 'Subject (sub) / Services ID',
                        value: 'Missing in payload',
                        status: 'error'
                    });
                    hasErrors = true;
                }

                // Check audience (aud) - should be Apple's OAuth endpoint
                if (payload.aud === 'https://appleid.apple.com') {
                    checks.push({
                        label: 'Audience (aud)',
                        value: payload.aud + ' ‚úì Correct',
                        status: 'success'
                    });
                } else if (payload.aud) {
                    checks.push({
                        label: 'Audience (aud)',
                        value: payload.aud + ' (expected: https://appleid.apple.com)',
                        status: 'warning'
                    });
                    hasWarnings = true;
                } else {
                    checks.push({
                        label: 'Audience (aud)',
                        value: 'Missing in payload',
                        status: 'warning'
                    });
                    hasWarnings = true;
                }

                // Check issued at (iat)
                if (payload.iat) {
                    const iatDate = formatDate(payload.iat);
                    checks.push({
                        label: 'Issued At (iat)',
                        value: iatDate,
                        status: 'info'
                    });
                }

                // Check expiration (exp)
                if (payload.exp) {
                    const expDate = formatDate(payload.exp);
                    const now = Math.floor(Date.now() / 1000);
                    const isExpired = payload.exp < now;
                    const daysUntilExpiry = Math.floor((payload.exp - now) / 86400);

                    if (isExpired) {
                        checks.push({
                            label: 'Expiration (exp)',
                            value: expDate + ' ‚ùå EXPIRED',
                            status: 'error'
                        });
                        hasErrors = true;
                    } else if (daysUntilExpiry < 30) {
                        checks.push({
                            label: 'Expiration (exp)',
                            value: expDate + ' ‚ö† Expires in ' + daysUntilExpiry + ' days',
                            status: 'warning'
                        });
                        hasWarnings = true;
                    } else {
                        checks.push({
                            label: 'Expiration (exp)',
                            value: expDate + ' ‚úì Valid for ' + daysUntilExpiry + ' days',
                            status: 'success'
                        });
                    }
                } else {
                    checks.push({
                        label: 'Expiration (exp)',
                        value: 'Missing (should have expiration)',
                        status: 'warning'
                    });
                    hasWarnings = true;
                }

                // Build results HTML
                let resultsHTML = `
                    <div class="section ${hasErrors ? 'error' : (hasWarnings ? 'warning' : 'success')}">
                        <h2>${hasErrors ? '‚ùå Validation Failed' : (hasWarnings ? '‚ö†Ô∏è Validation Passed with Warnings' : '‚úÖ Validation Passed')}</h2>
                `;

                checks.forEach(check => {
                    const iconClass = check.status === 'success' ? 'success' : 
                                    check.status === 'error' ? 'error' : 
                                    check.status === 'warning' ? 'warning' : 'info';
                    
                    resultsHTML += `
                        <div class="check-item ${iconClass}">
                            <span class="label">${check.label}:</span>
                            <span class="value">${check.value}</span>
                        </div>
                    `;
                });

                resultsHTML += `</div>`;

                // Add Supabase Configuration Verification Section
                const supabaseChecks = [];
                let supabaseHasErrors = false;
                
                // Extract values from JWT
                const jwtKeyId = header.kid || 'MISSING';
                const jwtTeamId = payload.iss || 'MISSING';
                const jwtServicesId = payload.sub || 'MISSING';

                supabaseChecks.push({
                    label: 'Secret Key (for OAuth)',
                    value: '‚úì Paste this JWT into Supabase',
                    status: 'success',
                    instruction: 'Copy the JWT secret you just validated and paste it into Supabase Dashboard ‚Üí Authentication ‚Üí Providers ‚Üí Apple ‚Üí Secret Key (for OAuth)'
                });

                if (jwtKeyId && jwtKeyId !== 'MISSING') {
                    if (jwtKeyId === EXPECTED_KEY_ID) {
                        supabaseChecks.push({
                            label: 'Key ID',
                            value: jwtKeyId + ' ‚úì Correct',
                            status: 'success',
                            instruction: 'In Supabase, set Key ID to: ' + jwtKeyId
                        });
                    } else {
                        supabaseChecks.push({
                            label: 'Key ID',
                            value: jwtKeyId + ' (expected: ' + EXPECTED_KEY_ID + ')',
                            status: 'warning',
                            instruction: '‚ö†Ô∏è The JWT contains Key ID: ' + jwtKeyId + ', but expected: ' + EXPECTED_KEY_ID + '. Verify which key is correct in Apple Developer Portal.'
                        });
                        supabaseHasErrors = true;
                    }
                }

                if (jwtTeamId && jwtTeamId !== 'MISSING') {
                    if (jwtTeamId === EXPECTED_TEAM_ID) {
                        supabaseChecks.push({
                            label: 'Team ID',
                            value: jwtTeamId + ' ‚úì Correct',
                            status: 'success',
                            instruction: 'In Supabase, set Team ID to: ' + jwtTeamId
                        });
                    } else {
                        supabaseChecks.push({
                            label: 'Team ID',
                            value: jwtTeamId + ' (expected: ' + EXPECTED_TEAM_ID + ')',
                            status: 'error',
                            instruction: '‚ùå Team ID mismatch! JWT has: ' + jwtTeamId + ', but expected: ' + EXPECTED_TEAM_ID
                        });
                        supabaseHasErrors = true;
                    }
                }

                if (jwtServicesId && jwtServicesId !== 'MISSING') {
                    if (jwtServicesId === EXPECTED_SERVICES_ID) {
                        supabaseChecks.push({
                            label: 'Services ID / Client ID',
                            value: jwtServicesId + ' ‚úì Correct',
                            status: 'success',
                            instruction: 'In Supabase, set Services ID / Client ID to: ' + jwtServicesId
                        });
                    } else {
                        supabaseChecks.push({
                            label: 'Services ID / Client ID',
                            value: jwtServicesId + ' (expected: ' + EXPECTED_SERVICES_ID + ')',
                            status: 'warning',
                            instruction: '‚ö†Ô∏è Services ID in JWT: ' + jwtServicesId + '. If Supabase says this is invalid, check Apple Developer Portal for the correct Services ID.'
                        });
                    }

                    // CRITICAL: Client IDs field - needs both web Services ID AND iOS bundle IDs
                    const requiredClientIds = [
                        jwtServicesId, // Web Services ID (required for website)
                        'com.playpadelpals.padelpals362' // iOS bundle ID (required for app)
                    ].filter((id, index, arr) => arr.indexOf(id) === index); // Remove duplicates
                    
                    supabaseChecks.push({
                        label: '‚ö†Ô∏è Client IDs field (CRITICAL)',
                        value: 'Must include ALL: Services ID + iOS bundle IDs',
                        status: 'success',
                        instruction: 'In Supabase, "Client IDs" field should contain ALL of these (comma-separated): ' + requiredClientIds.join(', ') + '. This enables both website AND mobile app authentication.'
                    });
                }

                // Build Supabase Configuration Section
                let supabaseHTML = `
                    <div class="section ${supabaseHasErrors ? 'error' : 'success'}">
                        <h2>üîß Supabase Configuration Checklist</h2>
                        <p style="margin-bottom: 15px; color: #666;">
                            Use these values from your JWT to configure Supabase Dashboard ‚Üí Authentication ‚Üí Providers ‚Üí Apple:
                        </p>
                `;

                supabaseChecks.forEach(check => {
                    const iconClass = check.status === 'success' ? 'success' : 
                                    check.status === 'error' ? 'error' : 
                                    check.status === 'warning' ? 'warning' : 'info';
                    
                    supabaseHTML += `
                        <div class="check-item ${iconClass}">
                            <div class="label">${check.label}:</div>
                            <div class="value">
                                ${check.value}
                                ${check.instruction ? '<div style="margin-top: 5px; font-size: 0.85rem; color: #666; font-style: italic;">' + check.instruction + '</div>' : ''}
                            </div>
                        </div>
                    `;
                });

                supabaseHTML += `</div>`;

                // Add Apple Developer Portal Configuration Section
                let appleHTML = `
                    <div class="section success">
                        <h2>üçé Apple Developer Portal Configuration Checklist</h2>
                        <p style="margin-bottom: 15px; color: #666;">
                            Verify these settings in Apple Developer Portal match your JWT values:
                        </p>
                        <div class="check-item info">
                            <div class="label">Key Configuration:</div>
                            <div class="value">
                                Key ID <strong>${jwtKeyId}</strong> should exist and have "Sign in with Apple" enabled
                            </div>
                        </div>
                        <div class="check-item info">
                            <div class="label">Services ID:</div>
                            <div class="value">
                                Services ID <strong>${jwtServicesId}</strong> should exist and be configured with:
                                <div style="margin-top: 8px; padding-left: 15px;">
                                    ‚Ä¢ Return URLs: <code>https://peaphqbxdmknxzsfdxuh.supabase.co/auth/v1/callback</code><br>
                                    ‚Ä¢ Domains: <code>supabase.co</code>
                                </div>
                            </div>
                        </div>
                        <div class="check-item info">
                            <div class="label">Team ID:</div>
                            <div class="value">
                                Team ID should be <strong>${jwtTeamId}</strong> (found in top right of Apple Developer Portal)
                            </div>
                        </div>
                    </div>
                `;

                // Add JWT Decoded Section
                let jwtHTML = `
                    <div class="section">
                        <h2>üìÑ JWT Details (Decoded)</h2>
                        <div style="margin-bottom: 15px;">
                            <strong>Header:</strong>
                            <div class="json-view">${formatJSON(header)}</div>
                        </div>
                        <div>
                            <strong>Payload:</strong>
                            <div class="json-view">${formatJSON(payload)}</div>
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = resultsHTML + supabaseHTML + appleHTML + jwtHTML;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="section error">
                        <h2>‚ùå Validation Error</h2>
                        <div class="check-item error">
                            <div class="value">${error.message}</div>
                        </div>
                        <p style="margin-top: 15px; color: #666;">
                            Make sure you're pasting the <strong>generated JWT secret</strong> (starts with "eyJ..."), 
                            not the raw .p8 file contents.
                        </p>
                    </div>
                `;
            }
        }

        // Allow Enter key to trigger validation (Ctrl/Cmd + Enter)
        document.getElementById('secretKeyInput').addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                validateSecretKey();
            }
        });
    </script>
</body>
</html>
